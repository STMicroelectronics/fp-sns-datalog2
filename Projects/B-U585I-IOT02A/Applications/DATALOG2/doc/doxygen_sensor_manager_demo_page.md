\mainpage Sensor Manager Demo
\tableofcontents

\section intro_sm Introduction
 SensorManager Demo is an eLooM-based application-level module that interfaces sensors of the B-U585I-IOT02A board and offers their data to other application modules.  
 It is working on Azure RTOS ThreadX.



\section folder_sm Folder structure

 The SensorManager demo is a FW application packed in a folder with all its source and include files.  
 It needs the \link sm_page SensorManager \endlink  and \link eLooM_main eLooM \endlink to work properly.  

 The SensorManager Demo folder contains the following kind of files:
 * Communication: managed tasks and interfaces that implements the bus peripheral communication.
 On this board, all the sensors are connected to the I2C bus.
 * Sensors: managed tasks and interfaces that implements the single sensor threads. The supported sensors in this demo are:
    + IIS2MDC
    + ISM330DHCX
    + LPS22HH
 * Middlewares: the demo is based on eLooM and works with the real time OS ThreadX
 * All the necessary drivers for the sensors and the bus  
 
\anchor fig1 \image html 27_packaging_diagram_SMdemo.PNG "Fig.1 - SensorManager demo files"

\section fw_arch_sm Firmware architecture

The SensorManager Demo is based on a 3 layer architecture. In the Application layer, we can find the sensor tasks, the I2C bus task and the HelloWorld Task of our demo.  
In the \ref fig2_demo "Fig2" we can see all these tasks in the Application layer. The I2CBusTask in charge to schedule and process the I2C request comes from all the sensor tasks.  
Under the Application layer we find the Service Layer, this layer is like a bridge between the tasks and the low level api.  
Last layer is the Low-Level API, in this layer there are the objects in charge to communicate with the component through a peripheral.  
In the mx folder, we can find the configuration files generated by CubeMX such as GPIOs, USART, I2C. We can also find the drivers for the Push button.

\anchor fig2_demo \image html 28_demo_app_architecture.png "Fig.2 - SensorManager demo 3 layers architecture"

 \section sm_app_tasks Application Tasks
 This section gives a look to the features exported by the application managed tasks. There are five application tasks plus one system task.

 | Index | Task name           | Task priority                    | Type of                 |
 | :---: | :------------------ | ---------------------------:     | :---------------------- |
 | 1     | HelloWorld          | TX_MAX_PRIORITIES-2         = 30 | ::AManagedTaskEx        |
 | 2     | IIS2MDC             | IIS2MDC_TASK_CFG_PRIORITY    = 6 | ::AManagedTaskEx        |
 | 3     | ISM330DHCX          | ISM330DHCX_TASK_CFG_PRIORITY = 6 | ::AManagedTaskEx        |
 | 4     | LPS22HH             | LPS22HH_TASK_CFG_PRIORITY    = 6 | ::AManagedTaskEx        |
 | 5     | I2CBUS              | I2CBUS_TASK_CFG_PRIORITY     = 4 | ::AManagedTaskEx        |
 |       |                     |                                  |                         |
 | 6     | INIT task           | INIT_TASK_CFG_PRIORITY       = 0 | system task             |
 | 7     | System Timer Thread | TX_MAX_PRIORITIES-2         = 30 | ThreadX task            |


 The scheduler executes the ready task with highest priority. The system is configured with 32 priority levels, from the lowest (31) to the highest (0).  
 The highest priority level (0) is not used by the managed tasks, because it is reserved to a special system task, the INIT task.  
 Each task is designed to respond to events generated by the MCU peripherals IRQ or by software events, for example messages.  

 | Index | IRQ line            | IRQ  priority  | Note                                                               |
 | :---: | :------------------ | :------------: | :----------------------------------------------------------------- |
 | 1     | GPDMA_Channel2_IRQn | 3              | DMA1 CH2 used to detect the I2C1 RX events                        |
 | 2     | GPDMA_Channel3_IRQn | 3              | DMA1 CH3 used to detect the I2C1 TX events                        |
 | 3     | EXTI10_IRQn         | 5              | EXTI 10 used to detect IIS2MDC events                             |
 | 4     | EXTI11_IRQn         | 5              | EXTI 11 used to detect ISM330DHCX events                          |
 | 5     | EXTI2_IRQn          | 5              | EXTI 2 used to detect LPS22HH events                              |
 | 6     | EXTI13_IRQn         | 14             | EXTI 13 used to detect the user button events                     |
 |       |                     |                |                                                                   |
 | 9     | TIM7_IRQn           | 14             | High frequency tick to generate the timestamp in DEBUG            |
 | 10    | TIM6_IRQn           | 15             | generates the HAL 1ms tick                                        |
 | 11    | SysTick_IRQn        | 15             | generate the scheduler 1ms tick                                   |

  Note that, despite the task priorities, the Cortex-M defines the IRQ priorities from the lowest 15 to the highest 0.

 \section operating_sm Operating mode
 The main files in this SensorManager Demo are :
 * App.c : in this file, we declare the tasks objects for all the sensors, the I2C bus and the HelloWorldTask.
 Then, we allocate the task objects with their GPIO init params and add all these tasks objects to the context.  
 Finally, we connect all  the selected sensors to the I2C bus.
 If we want to be able to get the data from the sensors, we create an event source and add a listener.

 * HelloWorldTask.c :
 This file shows an example of how the sensor manager can be used for an application.  
 Before entering the task control loop, we configure the sensors we want to use.
 Then, in the control loop, we display a message and go to sleep mode if the user button is not pressed within a certain delay.  
 An API allows the user to set the timeout to enter the stop mode.  
 If the user button is pressed, the SensorActive control loop is activated and the sensors start to produce data.   

 \anchor fig3_demo \image html 26_pm_sensor_manager_demo.png "Fig.3 - Power mode states"
